<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.soomjd.soomjan.classRoom.model.dao.ClassRoomMapper">
    
    <resultMap type="com.soomjd.soomjan.classRoom.model.dto.ClassDTO" id="classResultMap">
    	<id column="CLASS_CODE" property="classCode"/>
    	<result column="CREATE_DATE" property="createDate"/>
    	<result column="CONTENTS" property="contents"/>
    	<result column="TAG" property="tag"/>
    	<result column="CATEGORY_CODE" property="categoryCode"/>
    	<result column="EMAIL" property="email"/>
    	<result column="BOARD_TYPE" property="boardType"/>
    	<result column="VIEWS" property="views"/>
    	<result column="MAX_COUNT" property="maxCount"/>
    	<result column="TITLE" property="title"/>
    	<result column="PRICE" property="price"/>
    	<result column="FILE_PATH" property="filePath"/>
    	<result column="ORG_FILE_PATH" property="orgFilePath"/>
    	<result column="NICKNAME" property="nickName" />
    </resultMap>
    
    <resultMap type="com.soomjd.soomjan.classRoom.model.dto.LearningPostDTO" id="learningPostResultMap">
    	<id column="POST_CODE" property="postCode"/>
    	<result column="WRITE_DATE" property="writeDate"/>
    	<result column="RE_DATE" property="reDate"/>
    	<result column="CONTENTS" property="contents"/>
    	<result column="EMAIL" property="email"/>
    	<result column="CLASS_CODE" property="classCode"/>
    	<result column="TITLE" property="title"/>
    	<result column="IS_DELETED" property="isDeleted"/>
    	<result column="NICKNAME" property="nickName" />
    </resultMap>
    
    <resultMap type="com.soomjd.soomjan.classRoom.model.dto.MokchaDTO" id="mokchaResultMap">
    	<id column="MOKCHA_CODE" property="mokchaCode"/>
    	<result column="MOKCHA_NAME" property="mokchaName"/>
    	<result column="WRITE_DATE" property="writeDate"/>
    	<result column="CONTENTS" property="contents"/>
    	<result column="CLASS_CODE" property="classCode"/>
    </resultMap>
    
    <resultMap type="com.soomjd.soomjan.classRoom.model.dto.ClassFileDTO" id="fileResultMap">
    	<id column="FILE_CODE" property="fileCode"/>
    	<result column="FILE_PATH" property="filePath"/>
    	<result column="EMAIL" property="email"/>
    	<result column="ORG_FILE_PATH" property="orgFilePath"/>
    	<result column="WRITE_DATE" property="writeDate"/>
    	<result column="MOKCHA_CODE" property="mokchaCode"/>
    	<result column="POST_CODE" property="postCode"/>
    	<result column="IS_DELETED" property="isDeleted"/>
    	<result column="NICKNAME" property="nickName"/>
    </resultMap>
    
    <select id="selectClassByClassCode" resultMap="classResultMap">
    	SELECT
    			  C.CLASS_CODE
		    	, C.CREATE_DATE
		    	, C.CONTENTS
		    	, C.TAG
		    	, C.CATEGORY_CODE
		    	, C.EMAIL
		    	, C.BOARD_TYPE
		    	, C.VIEWS
		    	, C.MAX_COUNT
		    	, C.TITLE
		    	, C.PRICE
		    	, C.FILE_PATH
		    	, C.ORG_FILE_PATH
		    	, J.NICKNAME
    	  FROM CLASS_TBL C
    	  JOIN JANDI_TBL J ON (C.EMAIL = J.EMAIL)
    	 WHERE C.CLASS_CODE = #{ classCode }
    	   AND C.IS_DELETED = 'N'
    	  ORDER BY C.CREATE_DATE DESC
    </select>
    
    <select id="selectCurrentMemberList" resultType="hashmap">
    	SELECT EMAIL
    	  FROM PURCHASE_CLASS_TBL
    	 WHERE STATUS = 'Y'
    	   AND CLASS_CODE = #{ classCode }
    </select>
    
    <select id="selectMokchaList" resultMap="mokchaResultMap">
    	SELECT
    		   M.MOKCHA_CODE
		 	 , M.MOKCHA_NAME
			 , M.WRITE_DATE
			 , M.CONTENTS
			 , M.CLASS_CODE
		 FROM LECTURE_MOKCHA_TBL M
		WHERE M.CLASS_CODE = #{ classCode }
		  AND M.IS_DELETED = 'N'
		ORDER BY M.MOKCHA_CODE DESC
    </select>
    
    <select id="selectLearningPostList" resultMap="learningPostResultMap">
    	SELECT
    		   L.POST_CODE
			 , L.WRITE_DATE
			 , L.RE_DATE
			 , L.IS_DELETED
			 , L.CONTENTS
			 , L.EMAIL
			 , L.CLASS_CODE
			 , L.TITLE
			 , J.NICKNAME
		  FROM LEARNING_TBL L
		  JOIN JANDI_TBL J ON (J.EMAIL = L.EMAIL)
		 WHERE L.CLASS_CODE = #{ classCode }
		   AND L.IS_DELETED = 'N'
		  ORDER BY L.WRITE_DATE DESC
    </select>
    
    <select id="selectChatRoomList" resultType="hashMap" parameterType="hashMap">
    	SELECT 
    		   C.CHAT_CODE
    		 , C.EMAIL
    		 , C.CLASS_CODE
    		 , S.NICKNAME
    	  FROM CLASS_CHAT_ROOM_TBL C
    	  JOIN SSACK_TBL S ON (C.EMAIL = S.EMAIL)
    	 WHERE C.CLASS_CODE = #{ classCode }
    	   AND C.EMAIL != #{ email }
    </select>
    
    <insert id="registClass" parameterType="ClassDTO">
    	INSERT INTO CLASS_TBL
    	(
			 CLASS_CODE
		   , TITLE
		   , CATEGORY_CODE
		   , EMAIL
		   , MAX_COUNT
		   , PRICE
		   , CREATE_DATE

    	) VALUES (
    		 SEQ_CLASS_TBL.NEXTVAL
		   , #{ title }
		   , #{ categoryCode }
		   , #{ email }
		   , #{ maxCount }
		   , #{ price }
		   , SYSDATE
    	)
    </insert>
    
    <select id="selectClassCode" resultType="_int">
    	SELECT MAX(CLASS_CODE)
    	  FROM CLASS_TBL
    	 WHERE EMAIL = #{ email }
    </select>
    
    <select id="selectClassCodeList" resultType="hashmap">
    	SELECT 
    		   CLASS_CODE
    		 , TITLE
    	  FROM CLASS_TBL
    	 WHERE EMAIL = #{ email }
    	   AND IS_DELETED = 'N'
    	  ORDER BY CREATE_DATE DESC
    </select>
    
    <update id="deleteClass">
    	UPDATE CLASS_TBL
    	   SET IS_DELETED = 'Y'
    	 WHERE CLASS_CODE = #{ classCode }
    </update>
    
    <update id="modifyClass" parameterType="ClassDTO">
    	UPDATE CLASS_TBL
    	   SET CONTENTS = #{ contents }
    	   	 , TAG =  #{ tag } 
    	 WHERE CLASS_CODE = #{ classCode }
    </update>
    
    <insert id="registLecture" parameterType="MokchaDTO">
    	INSERT INTO LECTURE_MOKCHA_TBL
    	VALUES
    	(
    		  SEQ_LECTURE_MOKCHA_TBL.NEXTVAL
    		, #{ mokchaName }
    		, SYSDATE
    		, #{ contents }
    		, #{ classCode }
    		, 'N'
    	)
    </insert>
    
    <insert id="registLectureFile" parameterType="com.soomjd.soomjan.classRoom.model.dto.ClassFileDTO">
    	INSERT INTO LECTURE_FILE_TBL
    	VALUES
    	(
    		  SEQ_LECTURE_FILE_TBL.NEXTVAL
    		, SYSDATE
    		, #{ filePath }
    		, #{ orgFilePath }
    		, 'N'
    		, #{ mokchaCode }
    		, #{ email }
    	)
    </insert>
    
    <select id="selectPostByPostCode" resultMap="learningPostResultMap">
    	SELECT
    		   L.POST_CODE
			 , L.WRITE_DATE
			 , L.RE_DATE
			 , L.IS_DELETED
			 , L.CONTENTS
			 , L.EMAIL
			 , L.CLASS_CODE
			 , L.TITLE
			 , J.NICKNAME
		  FROM LEARNING_TBL L
		  JOIN JANDI_TBL J ON (J.EMAIL = L.EMAIL)
		 WHERE L.POST_CODE = #{ postCode }
		   AND L.IS_DELETED = 'N'
		  ORDER BY L.WRITE_DATE DESC
    </select>
    
    <select id="selectLearningFileList" resultMap="fileResultMap">
    	SELECT
    		   F.FILE_PATH
			 , F.EMAIL
			 , F.ORG_FILE_PATH
			 , F.WRITE_DATE
			 , F.FILE_CODE
			 , F.POST_CODE
			 , F.IS_DELETED
			 , S.NICKNAME
		  FROM LEARNING_FILE_TBL F
		  JOIN SSACK_TBL S ON (S.EMAIL = F.EMAIL)
		 WHERE F.POST_CODE = #{ postCode }
		   AND F.IS_DELETED = 'N'
		  ORDER BY F.WRITE_DATE DESC
    </select>
    
    <select id="selectMokchaFileList" resultMap="fileResultMap">
    	SELECT
    		   F.FILE_PATH
			 , F.EMAIL
			 , F.ORG_FILE_PATH
			 , F.UPLOAD_DATE
			 , F.FILE_CODE
			 , F.MOKCHA_CODE
			 , F.IS_DELETED
			 , J.NICKNAME
		  FROM LECTURE_FILE_TBL F
		  JOIN JANDI_TBL J ON (J.EMAIL = F.EMAIL)
		  JOIN LECTURE_MOKCHA_TBL M ON (M.MOKCHA_CODE = F.MOKCHA_CODE)
		 WHERE M.CLASS_CODE = #{ classCode }
		   AND F.IS_DELETED = 'N'
    </select>
    
      <update id="modifyLearnigPost" parameterType="LearningPostDTO">
    	UPDATE LEARNING_TBL
    	   SET CONTENTS = #{ contents }
    	   	 , TITLE =  #{ title } 
    	   	 , RE_DATE = SYSDATE
    	 WHERE POST_CODE = #{ postCode }
    </update>
    
    <insert id="registLearningFile" parameterType="com.soomjd.soomjan.classRoom.model.dto.ClassFileDTO">
    	INSERT INTO LEARNING_FILE_TBL
    	VALUES
    	(
    		  #{ filePath }
    		, #{ email }
    		, #{ orgFilePath }
    		, SYSDATE
    		, SEQ_LEARNING_FILE_TBL.NEXTVAL
    		, #{ postCode }
    		, 'N'
    		
    	)
    </insert>
    
    <insert id="registLearnigPost">
    	INSERT INTO LEARNING_TBL
    	VALUES
    	(
    		  SEQ_LEARNING_TBL.NEXTVAL
    		, SYSDATE
    		, SYSDATE
    		, 'N'
    		, NULL
    		, #{ email }
    		, #{ classCode }
    		, '제목 없음'
    	)
    </insert>
    
    <select id="selectNewPostCode" resultType="_int">
    	SELECT MAX(POST_CODE)
    	  FROM LEARNING_TBL
    	 WHERE EMAIL = #{ email }
    	   AND IS_DELETED = 'N'
    </select>
    
    <update id="modifyClassFile" parameterType="ClassDTO">
    	UPDATE CLASS_TBL
    	   SET FILE_PATH = #{ filePath }
    	     , ORG_FILE_PATH = #{ orgFilePath }
    	WHERE CLASS_CODE = #{ classCode }
    </update>
    
    <update id="modifyLectureIsDeleted">
    	UPDATE LECTURE_MOKCHA_TBL
    	   SET IS_DELETED = 'Y'
    	 WHERE MOKCHA_CODE = #{ mokchaCode }
    </update>
    
    <update id="modifyLectureFileIsDeleted">
    	UPDATE LECTURE_FILE_TBL
    	   SET IS_DELETED = 'Y'
    	 WHERE MOKCHA_CODE = #{ mokchaCode }
    </update>
    
    <select id="selectMokchaFileListByMokchaCode" resultMap="fileResultMap">
    	SELECT FILE_PATH
    	  FROM LEARNING_TBL
    	 WHERE MOKCHA_CODE = #{ mokchaCode }
    </select>
    
    <update id="modifyLearnigPostIsDeleted">
    	UPDATE LEARNING_TBL
    	   SET IS_DELETED = 'Y'
    	 WHERE POST_CODE = #{ postCode }
    </update>
    
    <update id="modifyLearningFileIsDeleted">
    	UPDATE LEARNING_FILE_TBL
    	   SET IS_DELETED = 'Y'
    	 WHERE POST_CODE = #{ postCode }
    </update>
    
    <select id="selectLearningFileListByPostCode" resultMap="fileResultMap">
    	SELECT FILE_PATH
    	  FROM LEARNING_FILE_TBL
    	 WHERE POST_CODE = #{ postCode }
    </select>
    
    <insert id="registPurchaseClass" parameterType="com.soomjd.soomjan.classRoom.model.dto.ClassPurchaseDTO">
    	INSERT ALL 
		  INTO PAYMENT_TBL VALUES(
		  SEQ_PAYMENT_TBL.NEXTVAL,
		  #{ payment.pay },
		  #{ payment.bank },
		  #{ payment.owner },
		  #{ payment.account },
		  SYSDATE,
		  #{ payment.payType }
		  )
		  INTO PURCHASE_CLASS_TBL VALUES(
		  #{ email },
		  #{ classCode },
		  'Y',
		  SEQ_PAYMENT_TBL.CURRVAL,
		  SEQ_PURCHASE_CLASS_TBL.NEXTVAL,
		  SYSDATE + 30
		  )SELECT * 
		   FROM DUAL
    </insert>
    
    <insert id="registChatRoom" parameterType="hashmap">
    	INSERT ALL 
		   INTO CLASS_CHAT_ROOM_TBL VALUES(
		   SEQ_CLASS_CHAT_ROOM_TBL.NEXTVAL,
		   #{ jandiEmail },
		   #{ classCode }
		   )
		   INTO CLASS_CHAT_ROOM_TBL VALUES(
		   SEQ_CLASS_CHAT_ROOM_TBL.CURRVAL,
		   #{ email },
		   #{ classCode }
		   )SELECT * 
		    FROM DUAL
    </insert>
    
    <select id="selectClassChatBySSACKEmail" parameterType="hashmap" resultType="_int">
    	SELECT C.CHAT_CODE
    	  FROM CLASS_CHAT_ROOM_TBL C
    	  JOIN SSACK_TBL S ON (C.EMAIL = S.EMAIL)
    	 WHERE C.CLASS_CODE = #{ classCode }
    	   AND C.EMAIL = #{ email }
    </select>
    
    <select id="selectAllReportStatement" resultType="hashmap">
    	select * FROM REPORT_STATEMENT_TBL
    </select>
    
    <insert id="registReportMember" parameterType="com.soomjd.soomjan.member.model.dto.ReportMemberDTO">
    	INSERT INTO 
    	REPORT_MEMBER_TBL(
			      EMAIL
			   , REP_CODE
			   , CONTENTS
			   , REP_DATE
			   , IMG_PATH
			   , REP_EMAIL
			   , REP_TYPE_CODE
			   , ORG_IMG_PATH
			   , REP_YN
			   
			)VALUES(
			   #{ email }
			   , SEQ_REPORT_MEMBER.NEXTVAL
			   , #{ contents }
			   , SYSDATE
			   , #{ imgPath }
			   , #{ repEmail }
			   , #{ repTypeCode }
			   , #{ orgImgPath }
			   , 'W'
			)
    </insert>
    
    <select id="selectLearningBoardTotalCount" resultType="_int" parameterType="HashMap">
    	SELECT
    	       COUNT(*)
    	  FROM LEARNING_TBL
    	 WHERE CLASS_CODE = #{ classCode }
    </select>
    
    <select id="selectLearningBoardList" resultType="hashmap">
    	SELECT
    	       F.RNUM
    	     , F.POST_CODE
    	     , F.WRITE_DATE
    	     , F.RE_DATE
    	     , F.IS_DELETED
    	     , F.CONTENTS
    	     , F.EMAIL
    	     , F.CLASS_CODE
    	     , F.TITLE
    	 FROM (SELECT ROWNUM RNUM
    	 	        , D.POST_CODE
    	 	        , D.WRITE_DATE
    	 	        , D.RE_DATE
    	 	        , D.IS_DELETED
    	 	        , D.CONTENTS
    	 	        , D.EMAIL
    	 	        , D.CLASS_CODE
    	 	        , D.TITLE
    	 	     FROM (SELECT
    	 	     			  L.POST_CODE
    	 	     			, L.WRITE_DATE
    	 	     			, L.RE_DATE
    	 	     			, L.IS_DELETED
    	 	     			, L.CONTENTS
    	 	     			, L.EMAIL
    	 	     			, L.CLASS_CODE
    	 	     			, L.TITLE
    	 	     	     FROM LEARNING_TBL L
    	 	     	    WHERE L.CLASS_CODE = #{ classCode }
    	 	     	      AND L.IS_DELETED = 'N'
    	 	     	    ORDER BY L.WRITE_DATE DESC
    	 	     ) D
    	    <![CDATA[
	        WHERE ROWNUM <= #{ selectCriteria.endRow } 
	        ]]>	
		  	) F
		  	WHERE F.RNUM >= #{ selectCriteria.startRow }  
    </select>
    
    <update id="viewsUp" parameterType="HashMap">
        UPDATE 
		       CLASS_TBL A 
		   SET A.VIEWS = A.VIEWS + 1
		   <where>
		       A.CLASS_CODE = #{ classCode }
		    <if test='email != null'>
		        AND A.EMAIL <![CDATA[ <> ]]> #{ email }   
		    </if>
		    </where>
		   
    </update>
    
    
</mapper>